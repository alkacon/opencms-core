/*VIE may be freely distributed under the MIT license.*//* VIE 2.1.0alpha1 may be freely distributed under the MIT license. See http://viejs.org/ for more details. */(function(){var a=this,e=a.jQuery,f=a.Backbone,c=a._;var d=a.VIE=function(g){this.config=(g)?g:{};this.services={};this.jQuery=e;this.entities=new this.Collection();this.Entity.prototype.entities=this.entities;this.entities.vie=this;this.Entity.prototype.entityCollection=this.Collection;this.Entity.prototype.vie=this;this.Namespaces.prototype.vie=this;this.namespaces=new this.Namespaces((this.config.baseNamespace)?this.config.baseNamespace:"http://viejs.org/ns/",{owl:"http://www.w3.org/2002/07/owl#",rdfs:"http://www.w3.org/2000/01/rdf-schema#",rdf:"http://www.w3.org/1999/02/22-rdf-syntax-ns#",schema:"http://schema.org/",foaf:"http://xmlns.com/foaf/0.1/",geo:"http://www.w3.org/2003/01/geo/wgs84_pos#",dbpedia:"http://dbpedia.org/ontology/",dbprop:"http://dbpedia.org/property/",skos:"http://www.w3.org/2004/02/skos/core#",xsd:"http://www.w3.org/2001/XMLSchema#",sioc:"http://rdfs.org/sioc/ns#",dcterms:"http://purl.org/dc/terms/"});this.Type.prototype.vie=this;this.Types.prototype.vie=this;this.Attribute.prototype.vie=this;this.Attributes.prototype.vie=this;this.types=new this.Types();this.types.add("owl:Thing");if(this.config.classic===true){this.RDFa=new this.ClassicRDFa(this);this.RDFaEntities=new this.ClassicRDFaEntities(this);this.EntityManager=new this.ClassicEntityManager(this);this.cleanup=function(){this.entities.reset()}}};d.prototype.use=function(g,h){if(!h&&!g.name){throw new Error("Please provide a name for the service!")}g.vie=this;g.name=(h)?h:g.name;if(g.init){g.init()}this.services[g.name]=g;return this};d.prototype.service=function(g){if(!this.services[g]){throw"Undefined service "+g}return this.services[g]};d.prototype.getServicesArray=function(){return c.map(this.services,function(g){return g})};d.prototype.load=function(g){if(!g){g={}}g.vie=this;return new this.Loadable(g)};d.prototype.save=function(g){if(!g){g={}}g.vie=this;return new this.Savable(g)};d.prototype.remove=function(g){if(!g){g={}}g.vie=this;return new this.Removable(g)};d.prototype.analyze=function(g){if(!g){g={}}g.vie=this;return new this.Analyzable(g)};d.prototype.find=function(g){if(!g){g={}}g.vie=this;return new this.Findable(g)};d.prototype.loadSchema=function(h,g){g=(!g)?{}:g;if(!h){throw new Error("Please provide a proper URL")}else{var i=this;e.getJSON(h).success(function(j){d.Util.loadSchemaOrg(i,j,g.baseNS);if(g.success){g.success.call(i)}}).error(function(k,l,j){if(g.error){b.warn(k,l,j);g.error.call(i,"Could not load schema from URL ("+h+")")}})}return this};d.prototype.getTypedEntityClass=function(i){var h=this.types.get(i);if(!h){throw new Error("Unknown type "+i)}var g=function(j,k){if(!j){j={}}j["@type"]=i;this.set(j,k)};g.prototype=new this.Entity();g.prototype.schema=function(){return d.Util.getFormSchemaForType(h)};return g};var b={info:function(){},log:function(){},warn:function(){}};if(!b.warn){b.warn=b.info}if(typeof exports==="object"){exports.VIE=d;if(!e){e=require("jquery")}if(!f){f=require("backbone");f.setDomLibrary(e)}if(!c){c=require("underscore")._}}d.prototype.Able=function(){this.init=function(h,g){this.options=h;this.services=h.from||h.using||h.to||[];this.vie=h.vie;this.methodName=g;this.deferred=e.Deferred();this.resolve=this.deferred.resolve;this.resolveWith=this.deferred.resolveWith;this.reject=this.deferred.reject;this.rejectWith=this.deferred.rejectWith;this.success=this.done=this.deferred.done;this.fail=this.deferred.fail;this.then=this.deferred.then;this.always=this.deferred.always;this.from=this.using;this.to=this.using;return this};this.using=function(h){var g=this;h=(c.isArray(h))?h:[h];c.each(h,function(i){var j=(typeof i==="string")?g.vie.service(i):i;g.services.push(j)});return this};this.execute=function(){var g=this;c(this.services).each(function(h){h[g.methodName](g)});return this}};d.prototype.Loadable=function(g){this.init(g,"load")};d.prototype.Loadable.prototype=new d.prototype.Able();d.prototype.Savable=function(g){this.init(g,"save")};d.prototype.Savable.prototype=new d.prototype.Able();d.prototype.Removable=function(g){this.init(g,"remove")};d.prototype.Removable.prototype=new d.prototype.Able();d.prototype.Analyzable=function(g){this.init(g,"analyze")};d.prototype.Analyzable.prototype=new d.prototype.Able();d.prototype.Findable=function(g){this.init(g,"find")};d.prototype.Findable.prototype=new d.prototype.Able();d.Util={toCurie:function(h,l,j){if(d.Util.isCurie(h,j)){return h}var m=":";for(var g in j.toObj()){if(h.indexOf(j.get(g))===1){var i=new RegExp("^<?"+j.get(g));if(g===""){m=""}return((l)?"[":"")+h.replace(i,g+m).replace(/>$/,"")+((l)?"]":"")}}throw new Error("No prefix found for URI '"+h+"'!")},isCurie:function(g,h){if(d.Util.isUri(g)){return false}else{try{d.Util.toUri(g,h);return true}catch(i){return false}}},toUri:function(g,j){var k=":";for(var i in j.toObj()){if(i!==""&&(g.indexOf(i+":")===0||g.indexOf("["+i+":")===0)){var h=new RegExp("^\\[{0,1}"+i+k);return"<"+g.replace(h,j.get(i)).replace(/\]{0,1}$/,"")+">"}}if(g.indexOf(k)===-1){return"<"+j.base()+g+">"}throw new Error("No prefix found for CURIE '"+g+"'!")},isUri:function(g){return(typeof g==="string"&&g.search(/^<.+>$/)===0)},mapAttributeNS:function(g,i){var h=g;if(i.isUri(g)||g.indexOf("@")===0){}else{if(i.isCurie(g)){h=i.uri(g)}else{if(!i.isUri(g)){if(g.indexOf(":")===-1){h="<"+i.base()+g+">"}else{h="<"+g+">"}}}}return h},rdf2Entities:function(n,h){if(typeof e.rdf!=="function"){return d.Util._rdf2EntitiesNoRdfQuery(n,h)}try{var m=(h instanceof e.rdf)?h.base(n.vie.namespaces.base()):e.rdf().base(n.vie.namespaces.base()).load(h,{});if(n.rules){var q=e.rdf.ruleset();for(var k in n.vie.namespaces.toObj()){if(k!==""){q.prefix(k,n.vie.namespaces.get(k))}}for(var j=0;j<n.rules.length;j++){if(n.rules.hasOwnProperty(j)){var p=n.rules[j];q.add(p.left,p.right)}}m=m.reason(q,10)}var l={};m.where("?subject ?property ?object").each(function(){var r=this.subject.toString();if(!l[r]){l[r]={"@subject":r,"@context":n.vie.namespaces.toObj(true),"@type":[]}}var t=this.property.toString();var u;try{u=n.vie.namespaces.curie(t)}catch(s){u=t}l[r][u]=l[r][u]||[];function i(v){if(typeof v.value==="string"){if(v.lang){var w={toString:function(){return this["@value"]},"@value":v.value.replace(/^"|"$/g,""),"@language":v.lang};return w}else{return v.value}return v.value.toString()}else{if(v.type==="uri"){return v.toString()}else{return v.value}}}l[r][u].push(i(this.object))});c(l).each(function(i){i["@type"]=i["@type"].concat(i["rdf:type"]);delete i["rdf:type"];c(i).each(function(s,r){if(s.length===1){i[r]=s[0]}})});var g=[];e.each(l,function(){var i=new n.vie.Entity(this);i=n.vie.entities.addOrUpdate(i);g.push(i)});return g}catch(o){b.warn("Something went wrong while parsing the returned results!",o);return[]}},getPreferredLangForPreferredProperty:function(m,r,j){var k,u,i,h,t,q,o,s,g,n=this;q=[];for(k=0,s=j.length;k<s;k++){i=j[k];for(h=0,g=r.length;h<g;h++){t=r[h];u=null;if(typeof t==="string"&&m.get(t)){u=c.flatten([m.get(t)]);c(u).each(function(l){var p,w,v;w=h;p=l["@language"];if(typeof l==="string"&&(l.indexOf("@")===l.length-3||l.indexOf("@")===l.length-5)){p=l.replace(/(^\"*|\"*@)..(..)?$/g,"")}if(p){if(p===i){w+=k}else{w+=20}}else{w+=10}v=l.toString();v=v.replace(/(^\"*|\"*@..$)/g,"");return q.push({score:w,value:v})})}else{if(typeof t==="object"&&m.get(t.property)){o=c.flatten([m.get(t.property)]);o=c(o).map(function(l){if(l.isEntity){return l.getSubject()}else{return l}});q.push({score:h,value:t.makeLabel(o)})}}}}q=c(q).sortBy(function(l){return l.score});if(q.length){return q[0].value}else{return"n/a"}},_rdf2EntitiesNoRdfQuery:function(g,h){var i=[];c.forEach(h,function(l,k){var j={};j["@subject"]="<"+k+">";c.forEach(l,function(n,m){m="<"+m+">";c.forEach(n,function(o){if(o.type==="uri"){o.value="<"+o.value+">"}if(j[m]&&!c.isArray(j[m])){j[m]=[j[m]]}if(c.isArray(j[m])){j[m].push(o.value);return}j[m]=o.value})});i.push(j)});return i},loadSchemaOrg:function(n,l,o){if(!l){throw new Error("Please load the schema.json file.")}n.types.remove("<http://schema.org/Thing>");var i=(o)?o:n.namespaces.base();n.namespaces.base(o);var j={DataType:"xsd:anyType",Boolean:"xsd:boolean",Date:"xsd:date",DateTime:"xsd:dateTime",Time:"xsd:time",Float:"xsd:float",Integer:"xsd:integer",Number:"xsd:anySimpleType",Text:"xsd:string",URL:"xsd:anyURI"};var k=function(u,v){var t=n.types.add(v,[{id:"value",range:j[v]}]);for(var s=0;s<u.length;s++){var r=(n.types.get(u[s]))?n.types.get(u[s]):k.call(n,l.datatypes[u[s]].supertypes,u[s]);t.inherit(r)}return t};for(var h in l.datatypes){if(!n.types.get(h)){var q=l.datatypes[h].supertypes;k.call(n,q,h)}}var m=function(w){var u=[];var s=l.types[w]["specific_properties"];for(var v=0;v<s.length;v++){var t=s[v];var r=l.properties[t]["ranges"];u.push({id:t,range:r})}return u};var g=function(v,w,u){var t=n.types.add(w,u);for(var s=0;s<v.length;s++){var r=(n.types.get(v[s]))?n.types.get(v[s]):g.call(n,l.types[v[s]].supertypes,v[s],m.call(n,v[s]));t.inherit(r)}if(w==="Thing"&&!t.isof("owl:Thing")){t.inherit("owl:Thing")}return t};for(var p in l.types){if(!n.types.get(p)){var q=l.types[p].supertypes;g.call(n,q,p,m.call(n,p))}}n.namespaces.base(i)},getEntityTypeUnion:function(g){var h=g.vie;return new h.Type("Union").inherit(g.get("@type"))},getFormSchemaForType:function(h,g){var i={};c.each(h.attributes.toArray(),function(k){var j=d.Util.toCurie(k.id,false,k.vie.namespaces);i[j]=d.Util.getFormSchemaForAttribute(k)});c.each(i,function(j,k){if(!j.type){delete i[k]}if(j.type==="URL"){j.type="Text";j.dataType="url"}if(j.type==="List"&&!j.listType){delete i[k]}if(!g){if(j.type==="NestedModel"||j.listType==="NestedModel"){delete i[k]}}});return i},getFormSchemaForAttribute:function(i){var g=i.range[0];var h={};var j=function(l){switch(l){case"xsd:anySimpleType":case"xsd:float":case"xsd:integer":return"Number";case"xsd:string":return"Text";case"xsd:date":return"Date";case"xsd:dateTime":return"DateTime";case"xsd:boolean":return"Checkbox";case"xsd:anyURI":return"URL";default:var k=i.vie.types.get(l);if(!k){return null}if(k.attributes.get("value")){return j(k.attributes.get("value").range[0])}return"NestedModel"}};h.title=d.Util.toCurie(i.id,false,i.vie.namespaces);if(i.min>0){h.validators=["required"]}if(i.max>1){h.type="List";h.listType=j(g);if(h.listType==="NestedModel"){h.nestedModelType=g}return h}h.type=j(g);if(h.type==="NestedModel"){h.nestedModelType=g}return h},getFormSchema:function(h){if(!h||!h.isEntity){return{}}var g=d.Util.getEntityTypeUnion(h);var i=d.Util.getFormSchemaForType(g,true);c.each(i,function(j,k){if(j.type!=="NestedModel"&&j.listType!=="NestedModel"){return}i[k].model=h.vie.getTypedEntityClass(j.nestedModelType)});return i},xsdDateTime:function(h){function m(p){var o=p.toString();return o.length<2?"0"+o:o}var n=h.getFullYear();var l=m(h.getMonth()+1);var g=m(h.getDate());var j=m(h.getHours());var k=m(h.getMinutes());var i=m(h.getSeconds());return n+"-"+l+"-"+g+"T"+j+":"+k+":"+i},extractLanguageString:function(q,t,o){if(q&&typeof q!=="string"){t=(c.isArray(t))?t:[t];o=(c.isArray(o))?o:[o];for(var h=0;h<t.length;h++){for(var m=0;m<o.length;m++){var j=o[m];var s=t[h];if(q.has(s)){var g=q.get(s);g=(c.isArray(g))?g:[g];for(var r=0;r<g.length;r++){var k=g[r];if(k.isEntity){k=d.Util.extractLanguageString(k,t,j)}else{if(typeof k==="string"){k=k}else{k=""}}if(k&&k.indexOf("@"+j)>-1){return k.replace(/"/g,"").replace(/@[a-z]+/,"").trim()}}}}}for(var h=0;h<t.length;h++){var s=t[h];if(q.has(s)){var g=q.get(s);g=(c.isArray(g))?g:[g];for(var r=0;r<g.length;r++){var k=g[r];if(k.isEntity){k=d.Util.extractLanguageString(k,t,[])}if(k&&(typeof k==="string")&&k.indexOf("@")===-1){return k.replace(/"/g,"").replace(/@[a-z]+/,"").trim()}}}}}return undefined},transformationRules:function(g){var h=[{left:["?subject a dbpedia:Person","?subject rdfs:label ?label"],right:function(i){return function(){return[e.rdf.triple(this.subject.toString(),"a","<"+i.base()+"Person>",{namespaces:i.toObj()}),e.rdf.triple(this.subject.toString(),"<"+i.base()+"name>",this.label,{namespaces:i.toObj()})]}}(g.vie.namespaces)},{left:["?subject a foaf:Person","?subject rdfs:label ?label"],right:function(i){return function(){return[e.rdf.triple(this.subject.toString(),"a","<"+i.base()+"Person>",{namespaces:i.toObj()}),e.rdf.triple(this.subject.toString(),"<"+i.base()+"name>",this.label,{namespaces:i.toObj()})]}}(g.vie.namespaces)},{left:["?subject a dbpedia:Place","?subject rdfs:label ?label"],right:function(i){return function(){return[e.rdf.triple(this.subject.toString(),"a","<"+i.base()+"Place>",{namespaces:i.toObj()}),e.rdf.triple(this.subject.toString(),"<"+i.base()+"name>",this.label.toString(),{namespaces:i.toObj()})]}}(g.vie.namespaces)},{left:["?subject a dbpedia:City","?subject rdfs:label ?label","?subject dbpedia:abstract ?abs","?subject dbpedia:country ?country"],right:function(i){return function(){return[e.rdf.triple(this.subject.toString(),"a","<"+i.base()+"City>",{namespaces:i.toObj()}),e.rdf.triple(this.subject.toString(),"<"+i.base()+"name>",this.label.toString(),{namespaces:i.toObj()}),e.rdf.triple(this.subject.toString(),"<"+i.base()+"description>",this.abs.toString(),{namespaces:i.toObj()}),e.rdf.triple(this.subject.toString(),"<"+i.base()+"containedIn>",this.country.toString(),{namespaces:i.toObj()})]}}(g.vie.namespaces)},];return h},getAdditionalRules:function(h){var j={Work:"CreativeWork",Film:"Movie",TelevisionEpisode:"TVEpisode",TelevisionShow:"TVSeries",Website:"WebPage",Painting:"Painting",Sculpture:"Sculpture",Event:"Event",SportsEvent:"SportsEvent",MusicFestival:"Festival",FilmFestival:"Festival",Place:"Place",Continent:"Continent",Country:"Country",City:"City",Airport:"Airport",Station:"TrainStation",Hospital:"GovernmentBuilding",Mountain:"Mountain",BodyOfWater:"BodyOfWater",Company:"Organization",Person:"Person",};var i=new Array();for(var k in j){var g={left:["?subject a dbpedia:"+k,"?subject rdfs:label ?label"],right:function(l){return function(){return[e.rdf.triple(this.subject.toString(),"a","<"+l.base()+j[k]+">",{namespaces:l.toObj()}),e.rdf.triple(this.subject.toString(),"<"+l.base()+"name>",this.label.toString(),{namespaces:l.toObj()})]}}(h.vie.namespaces)};i.push(g)}return i}};d.prototype.Entity=function(h,i){h=(h)?h:{};i=(i)?i:{};var g=this;if(h["@type"]!==undefined){h["@type"]=(c.isArray(h["@type"]))?h["@type"]:[h["@type"]];h["@type"]=c.map(h["@type"],function(k){if(!g.vie.types.get(k)){g.vie.types.add(k).inherit("owl:Thing")}return g.vie.types.get(k).id});h["@type"]=(h["@type"].length===1)?h["@type"][0]:h["@type"]}else{h["@type"]=g.vie.types.get("owl:Thing").id}c.each(h,function(l,k){var m=d.Util.mapAttributeNS(k,this.namespaces);if(k!==m){delete h[k];h[m]=l}},g.vie);var j=f.Model.extend({idAttribute:"@subject",initialize:function(k,l){if(k["@subject"]){this.id=this["@subject"]=this.toReference(k["@subject"])}else{this.id=this["@subject"]=k["@subject"]=this.cid.replace("c","_:bnode")}return this},schema:function(){return d.Util.getFormSchema(this)},get:function(k){k=d.Util.mapAttributeNS(k,g.vie.namespaces);var l=f.Model.prototype.get.call(this,k);l=(c.isArray(l))?l:[l];l=c.map(l,function(m){if(m!==undefined&&k==="@type"&&g.vie.types.get(m)){return g.vie.types.get(m)}else{if(m!==undefined&&g.vie.entities.get(m)){return g.vie.entities.get(m)}else{return m}}},this);if(l.length===0){return undefined}l=(l.length===1)?l[0]:l;return l},has:function(k){k=d.Util.mapAttributeNS(k,g.vie.namespaces);return f.Model.prototype.has.call(this,k)},set:function(m,l,n){if(!m){return this}if(m["@subject"]){m["@subject"]=this.toReference(m["@subject"])}if(typeof m==="string"){var o={};o[m]=l;return this.set(o,n)}if(m.attributes){m=m.attributes}var k=this;c.each(m,function(q,p){var r=d.Util.mapAttributeNS(p,k.vie.namespaces);if(p!==r){delete m[p];m[r]=q}},this);c.each(m,function(s,r){if(!s){return}if(r.indexOf("@")===-1){if(s.isCollection){s.each(function(u){k.vie.entities.addOrUpdate(u,{overrideAttributes:true})})}else{if(s.isEntity){k.vie.entities.addOrUpdate(s,{overrideAttributes:true});var q=new k.vie.Collection();q.vie=k.vie;q.add(s);m[r]=q}else{if(c.isArray(s)){if(this.attributes[r]&&this.attributes[r].isCollection){var p=this.attributes[r].addOrUpdate(s);m[r]=this.attributes[r];m[r].reset(p)}}else{if(s["@value"]){}else{if(typeof s=="object"){var t=new k.vie.Entity(s,l);k.vie.entities.addOrUpdate(t);var q=new k.vie.Collection();q.vie=k.vie;q.add(s);m[r]=q}else{}}}}}}},this);return f.Model.prototype.set.call(this,m,l)},unset:function(k,l){k=d.Util.mapAttributeNS(k,g.vie.namespaces);return f.Model.prototype.unset.call(this,k,l)},isNew:function(){if(this.getSubjectUri().substr(0,7)==="_:bnode"){return true}return false},hasChanged:function(k){if(this.markedChanged){return true}return f.Model.prototype.hasChanged.call(this,k)},forceChanged:function(k){this.markedChanged=k?true:false},getSubject:function(){if(typeof this.id==="undefined"){this.id=this.attributes[this.idAttribute]}if(typeof this.id==="string"){if(this.id.substr(0,7)==="http://"||this.id.substr(0,4)==="urn:"){return this.toReference(this.id)}return this.id}return this.cid.replace("c","_:bnode")},getSubjectUri:function(){return this.fromReference(this.getSubject())},isReference:function(k){var l=new RegExp("^\\<([^\\>]*)\\>$");if(l.exec(k)){return true}return false},toReference:function(n){if(c.isArray(n)){var k=this;return c.map(n,function(o){return k.toReference(o)})}var m=this.vie.namespaces;var l=n;if(n.substring(0,2)==="_:"){l=n}else{if(m.isCurie(n)){l=m.uri(n);if(l==="<"+m.base()+n+">"){l="<"+n+">"}}else{if(!m.isUri(n)){l="<"+n+">"}}}return l},fromReference:function(l){var k=this.vie.namespaces;if(!k.isUri(l)){return l}return l.substring(1,l.length-1)},as:function(k){if(k==="JSON"){return this.toJSON()}if(k==="JSONLD"){return this.toJSONLD()}throw new Error("Unknown encoding "+k)},toJSONLD:function(){var l={};var k=this;c.each(k.attributes,function(o,n){var m=o;if(o instanceof k.vie.Collection){m=o.map(function(p){return p.getSubject()})}l[n]=m});l["@subject"]=k.getSubject();return l},setOrAdd:function(m,l,n){var k=this;if(typeof m==="string"&&l){k._setOrAddOne(m,l,n)}else{if(typeof m==="object"){c(m).each(function(p,o){k._setOrAddOne(o,p,l)})}}return this},_setOrAddOne:function(l,p,n){if(!l||!p){return}n=(n)?n:{};l=d.Util.mapAttributeNS(l,g.vie.namespaces);if(c.isArray(p)){for(var m=0;m<p.length;m++){this._setOrAddOne(l,p[m],n)}return}if(l==="@type"&&p instanceof g.vie.Type){p=p.id}var q={};var o=f.Model.prototype.get.call(this,l);if(!o){q[l]=p;this.set(q,n)}else{if(o.isCollection){if(p.isCollection){p.each(function(r){o.add(r)})}else{if(p.isEntity){o.add(p)}else{if(typeof p==="object"){p=new this.vie.Entity(p);o.add(p)}else{throw new Error("you cannot add a literal to a collection of entities!")}}}this.trigger("change:"+l,this,p,{});this.change({})}else{if(c.isArray(o)){if(p.isCollection){for(var m=0;m<p.size();m++){this._setOrAddOne(l,p.at(m).getSubject(),n)}}else{if(p.isEntity){this._setOrAddOne(l,p.getSubject(),n)}else{if(typeof p==="object"){p=new this.vie.Entity(p);this._setOrAddOne(l,p,n)}else{o.push(p);q[l]=o;this.set(q)}}}}else{var k=[o];k.push(p);q[l]=k;return this.set(q,n)}}}},hasType:function(k){k=g.vie.types.get(k);return this.hasPropertyValue("@type",k)},hasPropertyValue:function(m,l){var k=this.get(m);if(!(l instanceof Object)){l=g.vie.entities.get(l)}if(k instanceof Array){return k.indexOf(l)!==-1}else{return k===l}},isof:function(m){var l=this.get("@type");if(l===undefined){return false}l=(c.isArray(l))?l:[l];m=(g.vie.types.get(m))?g.vie.types.get(m):new g.vie.Type(m);for(var k=0;k<l.length;k++){if(g.vie.types.get(l[k])){if(g.vie.types.get(l[k]).isof(m)){return true}}else{var n=new g.vie.Type(l[k]);if(n.id===m.id){return true}}}return false},addTo:function(l,m){var k=this;if(l instanceof k.vie.Collection){if(m){l.addOrUpdate(k)}else{l.add(k)}return this}throw new Error("Please provide a proper collection of type VIE.Collection as argument!")},isEntity:true,vie:g.vie});return new j(h,i)};d.prototype.Collection=f.Collection.extend({model:d.prototype.Entity,get:function(g){if(g===null){return null}g=(g.getSubject)?g.getSubject():g;if(typeof g==="string"&&g.indexOf("_:")===0){if(g.indexOf("bnode")===2){g=g.replace("_:bnode","c");return this._byCid[g]}else{return this._byId["<"+g+">"]}}else{g=this.toReference(g);return this._byId[g]}},addOrUpdate:function(h,g){g||(g={});var l=this;var j;if(c.isArray(h)){var k=[];c.each(h,function(m){k.push(l.addOrUpdate(m,g))});return k}if(h===undefined){throw new Error("No model given")}if(c.isString(h)&&l.isReference(h)){h={"@subject":h}}if(!h.isEntity){h=new this.model(h)}if(h.id&&this.get(h.id)){j=this.get(h.id)}if(this.getByCid(h.cid)){var j=this.getByCid(h.cid)}if(j){var i={};c.each(h.attributes,function(o,n){if(!j.has(n)){i[n]=o;return true}else{if(j.get(n)===o){return true}else{var p=j.attributes[n];var m=o;if(p instanceof l.vie.Collection){return true}if(g.overrideAttributes){i[n]=o;return true}if(n==="@context"){i[n]=e.extend(true,{},p,m)}else{p=(e.isArray(p))?p:[p];m=(e.isArray(m))?m:[m];i[n]=c.uniq(p.concat(m));i[n]=(i[n].length===1)?i[n][0]:i[n]}}}});if(!c.isEmpty(i)){j.set(i,g.updateOptions)}return j}this.add(h,g.addOptions);return h},isReference:function(g){var h=new RegExp("^\\<([^\\>]*)\\>$");if(h.exec(g)){return true}return false},toReference:function(g){if(this.isReference(g)){return g}return"<"+g+">"},fromReference:function(g){if(!this.isReference(g)){return g}return g.substring(1,g.length-1)},isCollection:true});if(d.prototype.Type){throw new Error("ERROR: VIE.Type is already defined. Please check your installation!")}if(d.prototype.Types){throw new Error("ERROR: VIE.Types is already defined. Please check your installation!")}d.prototype.Type=function(h,g){if(h===undefined||typeof h!=="string"){throw"The type constructor needs an 'id' of type string! E.g., 'Person'"}this.id=this.vie.namespaces.isUri(h)?h:this.vie.namespaces.uri(h);if(this.vie.types.get(this.id)){throw new Error("The type "+this.id+" is already defined!")}this.supertypes=new this.vie.Types();this.subtypes=new this.vie.Types();this.attributes=new this.vie.Attributes(this,(g)?g:[]);this.isof=function(i){i=this.vie.types.get(i);if(i){return i.subsumes(this.id)}else{throw new Error("No valid type given")}};this.subsumes=function(i){i=this.vie.types.get(i);if(i){if(this.id===i.id){return true}var j=this.subtypes.list();for(var l=0;l<j.length;l++){var k=j[l];if(k){if(k.id===i.id||k.subsumes(i)){return true}}}return false}else{throw new Error("No valid type given")}};this.inherit=function(j){if(typeof j==="string"){this.inherit(this.vie.types.get(j))}else{if(j instanceof this.vie.Type){j.subtypes.addOrOverwrite(this);this.supertypes.addOrOverwrite(j);try{this.attributes.list()}catch(m){j.subtypes.remove(this);this.supertypes.remove(j);throw m}}else{if(e.isArray(j)){for(var k=0,l=j.length;k<l;k++){this.inherit(j[k])}}else{throw new Error("Wrong argument in VIE.Type.inherit()")}}}return this};this.hierarchy=function(){var k={id:this.id,subtypes:[]};var j=this.subtypes.list();for(var m=0,i=j.length;m<i;m++){var l=this.vie.types.get(j[m]);k.subtypes.push(l.hierarchy())}return k};this.instance=function(j,k){j=(j)?j:{};k=(k)?k:{};if(k.typeChecking!==false){for(var i in j){if(i.indexOf("@")!==0&&!this.attributes.get(i)){throw new Error("Cannot create an instance of "+this.id+" as the type does not allow an attribute '"+i+"'!")}}}if(j["@type"]){j["@type"].push(this.id)}else{j["@type"]=this.id}return new this.vie.Entity(j,k)};this.toString=function(){return this.id}};d.prototype.Types=function(){this._types={};this.add=function(i,g){if(c.isArray(i)){c.each(i,function(j){this.add(j)},this);return this}if(this.get(i)){throw new Error("Type '"+i+"' already registered.")}else{if(typeof i==="string"){var h=new this.vie.Type(i,g);this._types[h.id]=h;return h}else{if(i instanceof this.vie.Type){this._types[i.id]=i;return i}else{throw new Error("Wrong argument to VIE.Types.add()!")}}}return this};this.addOrOverwrite=function(h,g){if(this.get(h)){this.remove(h)}return this.add(h,g)};this.get=function(h){if(!h){return undefined}if(typeof h==="string"){var g=this.vie.namespaces.isUri(h)?h:this.vie.namespaces.uri(h);return this._types[g]}else{if(h instanceof this.vie.Type){return this.get(h.id)}}return undefined};this.remove=function(k){var g=this.get(k);if(!g){return this}if(!g||g.subsumes("owl:Thing")){b.warn("You are not allowed to remove 'owl:Thing'.");return this}delete this._types[g.id];var h=g.subtypes.list();for(var j=0;j<h.length;j++){var i=h[j];if(i.supertypes.list().length===1){this.remove(i)}else{i.supertypes.remove(g.id)}}return g};this.toArray=this.list=function(){var g=[];for(var h in this._types){g.push(this._types[h])}return g};this.sort=function(j,i){var o=this;j=(e.isArray(j))?j:[j];i=(i)?true:false;if(j.length===0){return[]}var g=[j[0]];for(var m=1,h=j.length;m<h;m++){var n=j[m];var k=o.get(n);if(k){for(var l=0;l<g.length;l++){if(k.subsumes(g[l])){g.splice(l,0,n);break}else{if(l===g.length-1){g.push(n)}}}}}for(var m=0;m<g.length;m++){if(g.lastIndexOf(g[m])!==m){g.splice(m,1);m--}}if(!i){g.reverse()}return g}};if(d.prototype.Attribute){throw new Error("ERROR: VIE.Attribute is already defined. Please check your VIE installation!")}if(d.prototype.Attributes){throw new Error("ERROR: VIE.Attributes is already defined. Please check your VIE installation!")}d.prototype.Attribute=function(k,g,j,h,i){if(k===undefined||typeof k!=="string"){throw new Error("The attribute constructor needs an 'id' of type string! E.g., 'Person'")}if(g===undefined){throw new Error("The attribute constructor of "+k+" needs 'range'.")}if(j===undefined){throw new Error("The attribute constructor of "+k+" needs a 'domain'.")}this._domain=j;this.id=this.vie.namespaces.isUri(k)?k:this.vie.namespaces.uri(k);this.range=(c.isArray(g))?g:[g];h=h?h:0;this.min=(h>0)?h:0;i=i?i:1;if(i===-1){i=Number.MAX_VALUE}this.max=(i>=this.min)?i:this.min;this.applies=function(n){if(this.vie.types.get(n)){n=this.vie.types.get(n)}for(var o=0,m=this.range.length;o<m;o++){var l=this.vie.types.get(this.range[o]);if(l===undefined&&typeof n==="string"){if(n===this.range[o]){return true}}else{if(n.isof(this.range[o])){return true}}}return false}};d.prototype.Attributes=function(j,i){this._local={};this._attributes={};this.domain=j;this.add=function(o,m,n,k){if(c.isArray(o)){c.each(o,function(p){this.add(p)},this);return this}if(this.get(o)){throw new Error("Attribute '"+o+"' already registered for domain "+this.domain.id+"!")}else{if(typeof o==="string"){var l=new this.vie.Attribute(o,m,this.domain,n,k);this._local[l.id]=l;return l}else{if(o instanceof this.vie.Attribute){o.domain=this.domain;o.vie=this.vie;this._local[o.id]=o;return o}else{throw new Error("Wrong argument to VIE.Types.add()!")}}}};this.remove=function(l){var k=this.get(l);if(k.id in this._local){delete this._local[k.id];return k}throw new Error("The attribute "+l+" is inherited and cannot be removed from the domain "+this.domain.id+"!")};this.get=function(l){if(typeof l==="string"){var k=this.vie.namespaces.isUri(l)?l:this.vie.namespaces.uri(l);return this._inherit()._attributes[k]}else{if(l instanceof this.vie.Attribute){return this.get(l.id)}else{throw new Error("Wrong argument in VIE.Attributes.get()")}}};this._inherit=function(){var t=e.extend(true,{},this._local);var G=c.map(this.domain.supertypes.list(),function(p){return p.attributes});var w={};var o={};for(var F=0,u=G.length;F<u;F++){var D=G[F].list();for(var v=0,n=D.length;v<n;v++){var B=D[v].id;if(!(B in t)){if(!(B in w)&&!(B in o)){w[B]=D[v]}else{if(!o[B]){o[B]={range:[],mins:[],maxs:[]}}if(B in w){o[B]["range"]=e.merge(o[B]["range"],w[B].range);o[B]["mins"]=e.merge(o[B]["mins"],[w[B].min]);o[B]["maxs"]=e.merge(o[B]["maxs"],[w[B].max]);delete w[B]}o[B]["range"]=e.merge(o[B]["range"],D[v].range);o[B]["mins"]=e.merge(o[B]["mins"],[D[v].min]);o[B]["maxs"]=e.merge(o[B]["maxs"],[D[v].max]);o[B]["range"]=c.uniq(o[B]["range"]);o[B]["mins"]=c.uniq(o[B]["mins"]);o[B]["maxs"]=c.uniq(o[B]["maxs"])}}}}e.extend(t,w);for(var B in o){var A=o[B]["range"];var s=o[B]["mins"];var q=o[B]["maxs"];var m=[];for(var y=0,k=A.length;y<k;y++){var C=this.vie.types.get(A[y]);var H=false;if(C){for(var v=0;v<k;v++){if(v===y){continue}var E=this.vie.types.get(A[v]);if(E&&E.isof(C)){H=true;break}}}if(!H){m.push(A[y])}}var l=c.max(s);var z=c.min(q);if(l<=z&&z>=0&&l>=0){t[B]=new this.vie.Attribute(B,m,this,l,z)}else{throw new Error("This inheritance is not allowed because of an invalid minCount/maxCount pair!")}}this._attributes=t;return this};this.toArray=this.list=function(m){var n=[];var l=this._inherit()._attributes;for(var k in l){if(!m||l[k].applies(m)){n.push(l[k])}}return n};i=c.isArray(i)?i:[i];for(var h=0,g=i.length;h<g;h++){this.add(i[h].id,i[h].range,i[h].min,i[h].max)}};if(d.prototype.Namespaces){throw new Error("ERROR: VIE.Namespaces is already defined. Please check your VIE installation!")}d.prototype.Namespaces=function(h,g){if(!h){throw new Error("Please provide a base namespace!")}this._base=h;this._namespaces=(g)?g:{};if(typeof this._namespaces!=="object"||c.isArray(this._namespaces)){throw new Error("If you want to initialise VIE namespace prefixes, please provide a proper object!")}};d.prototype.Namespaces.prototype.base=function(g){if(!g){return this._base}else{if(typeof g==="string"){this.removeNamespace(g);this._base=g;return this._base}else{throw new Error("Please provide a valid namespace!")}}};d.prototype.Namespaces.prototype.add=function(h,g){if(typeof h==="object"){for(var i in h){this.add(i,h[i])}return this}if(h===""){this.base(g);return this}else{if(this.contains(h)&&g!==this._namespaces[h]){throw new Error("ERROR: Trying to register namespace prefix mapping ("+h+","+g+")!There is already a mapping existing: '("+h+","+this.get(h)+")'!")}else{e.each(this._namespaces,function(k,j){if(j===g&&k!==h){throw new Error("ERROR: Trying to register namespace prefix mapping ("+h+","+g+")!There is already a mapping existing: '("+k+","+g+")'!")}})}}this._namespaces[h]=g;return this};d.prototype.Namespaces.prototype.addOrReplace=function(h,g){if(typeof h==="object"){for(var i in h){this.addOrReplace(i,h[i])}return this}this.remove(h);this.removeNamespace(g);return this.add(h,g)};d.prototype.Namespaces.prototype.get=function(g){if(g===""){return this.base()}return this._namespaces[g]};d.prototype.Namespaces.prototype.getPrefix=function(g){var h=undefined;e.each(this._namespaces,function(j,i){if(i===g){h=j}});return h};d.prototype.Namespaces.prototype.contains=function(g){return(g in this._namespaces)};d.prototype.Namespaces.prototype.containsNamespace=function(g){return this.getPrefix(g)!==undefined};d.prototype.Namespaces.prototype.update=function(h,g){this.remove(h);return this.add(h,g)};d.prototype.Namespaces.prototype.updateNamespace=function(h,g){this.removeNamespace(h);return this.add(h,g)};d.prototype.Namespaces.prototype.remove=function(g){if(g){delete this._namespaces[g]}return this};d.prototype.Namespaces.prototype.removeNamespace=function(g){var h=this.getPrefix(g);if(h){delete this._namespaces[h]}return this};d.prototype.Namespaces.prototype.toObj=function(g){if(g){return e.extend({},this._namespaces)}return e.extend({"":this._base},this._namespaces)};d.prototype.Namespaces.prototype.curie=function(g,h){return d.Util.toCurie(g,h,this)};d.prototype.Namespaces.prototype.isCurie=function(g){return d.Util.isCurie(g,this)};d.prototype.Namespaces.prototype.uri=function(g){return d.Util.toUri(g,this)};d.prototype.Namespaces.prototype.isUri=d.Util.isUri;d.prototype.ClassicRDFa=function(g){this.vie=g};d.prototype.ClassicRDFa.prototype={readEntities:function(g){var h=[];var i=this.vie.RDFaEntities.getInstances(g);c.each(i,function(j){h.push(j.toJSONLD())});return h},findPredicateElements:function(i,h,g){return this.vie.services.rdfa.findPredicateElements(i,h,g)},getPredicate:function(g){return this.vie.services.rdfa.getElementPredicate(g)},getSubject:function(g){return this.vie.services.rdfa.getElementSubject(g)}};d.prototype.ClassicRDFaEntities=function(g){this.vie=g};d.prototype.ClassicRDFaEntities.prototype={getInstances:function(g){if(!this.vie.services.rdfa){this.vie.use(new this.vie.RdfaService())}var h=null;var i=false;this.vie.load({element:g}).from("rdfa").execute().done(function(j){h=j;i=true});while(!i){}return h},getInstance:function(g){var h=this.getInstances(g);if(h&&h.length){return h.pop()}return null}};d.prototype.ClassicEntityManager=function(g){this.vie=g;this.entities=this.vie.entities};d.prototype.ClassicEntityManager.prototype={getBySubject:function(g){return this.vie.entities.get(g)},getByJSONLD:function(g){if(typeof g==="string"){try{g=e.parseJSON(g)}catch(h){return null}}return this.vie.entities.addOrUpdate(g)},initializeCollection:function(){return}};(function(){d.prototype.DBPediaService=function(g){var h={name:"dbpedia",namespaces:{owl:"http://www.w3.org/2002/07/owl#",yago:"http://dbpedia.org/class/yago/",foaf:"http://xmlns.com/foaf/0.1/",georss:"http://www.georss.org/georss/",geo:"http://www.w3.org/2003/01/geo/wgs84_pos#",rdfs:"http://www.w3.org/2000/01/rdf-schema#",rdf:"http://www.w3.org/1999/02/22-rdf-syntax-ns#",dbpedia:"http://dbpedia.org/ontology/",dbprop:"http://dbpedia.org/property/",dcelements:"http://purl.org/dc/elements/1.1/"},rules:[]};this.options=e.extend(true,h,g?g:{});this.vie=null;this.name=this.options.name;e.ajaxSetup({converters:{"text application/rdf+json":function(i){return JSON.parse(i)}},timeout:60000})};d.prototype.DBPediaService.prototype={init:function(){for(var g in this.options.namespaces){var h=this.options.namespaces[g];this.vie.namespaces.add(g,h)}this.rules=e.extend([],d.Util.transformationRules(this));this.rules=e.merge(this.rules,(this.options.rules)?this.options.rules:[]);this.connector=new this.vie.DBPediaConnector(this.options);return this},load:function(m){var i=this;var k=m instanceof this.vie.Loadable;if(!k){throw new Error("Invalid Loadable passed")}var n=function(p){p=(typeof p==="string")?JSON.parse(p):p;c.defer(function(){try{var r=d.Util.rdf2Entities(i,p);r=(c.isArray(r))?r:[r];for(var q=0;q<r.length;q++){r[q].set("DBPediaServiceLoad",d.Util.xsdDateTime(new Date()))}r=(r.length===1)?r[0]:r;m.resolve(r)}catch(q){m.reject(q)}})};var l=function(p){m.reject(p)};var h=(m.options.entity)?m.options.entity:m.options.entities;if(!h){m.reject([])}else{h=(c.isArray(h))?h:[h];var o=[];for(var j=0;j<h.length;j++){var g=(typeof h[j]==="string")?h[j]:h[j].id;o.push(g)}this.connector.load(o,n,l)}return this}};d.prototype.DBPediaConnector=function(g){this.options=g;this.baseUrl="http://dbpedia.org/sparql?default-graph-uri=http%3A%2F%2Fdbpedia.org&timeout=0"};d.prototype.DBPediaConnector.prototype={load:function(h,m,k,p){if(!p){p={}}var g=this.baseUrl+"&format="+encodeURIComponent("application/rdf+json")+"&query=";if(c.isArray(h)){var o="";var i="";for(var n=0;n<h.length;n++){var j=(/^<.+>$/.test(h[n]))?h[n]:"<"+h[n]+">";if(n>0){o+=" .";i+=" UNION "}o+=" "+j+" ?prop"+n+" ?val"+n;i+=" { "+j+" ?prop"+n+" ?val"+n+" }"}g+=encodeURIComponent("CONSTRUCT {"+o+" } WHERE {"+i+" }")}else{h=(/^<.+>$/.test(h))?h:"<"+h+">";g+=encodeURIComponent("CONSTRUCT { "+h+" ?prop ?val } WHERE { "+h+" ?prop ?val }")}var l=p.format||"application/rdf+json";if(typeof exports!=="undefined"&&typeof process!=="undefined"){return this._loadNode(g,m,k,p,l)}e.ajax({success:function(q){m(q)},error:k,type:"GET",url:g,accepts:{"application/rdf+json":"application/rdf+json"}});return this},_loadNode:function(k,m,h,g,l){var j=require("request");var i=j({method:"GET",uri:k,headers:{Accept:l}},function(p,o,n){if(o.statusCode!==200){return h(n)}m(JSON.parse(n))});i.end();return this}}})();(function(){d.prototype.OpenCalaisService=function(g){var h={name:"opencalais",url:["http://api.opencalais.com/enlighten/rest/"],timeout:60000,namespaces:{opencalaisc:"http://s.opencalais.com/1/pred/",opencalaiscr:"http://s.opencalais.com/1/type/er/",opencalaiscm:"http://s.opencalais.com/1/type/em/e/"},rules:[]};this.options=e.extend(true,h,g?g:{});this.vie=null;this.name=this.options.name;e.ajaxSetup({converters:{"text application/rdf+json":function(i){return JSON.parse(i)}},timeout:this.options.timeout})};d.prototype.OpenCalaisService.prototype={init:function(){for(var g in this.options.namespaces){var h=this.options.namespaces[g];this.vie.namespaces.add(g,h)}this.rules=e.extend([],d.Util.transformationRules(this));this.rules=e.merge(this.rules,(this.options.rules)?this.options.rules:[]);this.connector=new this.vie.OpenCalaisConnector(this.options)},analyze:function(m){var g=this;var i=m instanceof this.vie.Analyzable;if(!i){throw"Invalid Analyzable passed"}var j=m.options.element?m.options.element:e("body");var l=g._extractText(j);if(l.length>0){var k=function(n){c.defer(function(){var o=d.Util.rdf2Entities(g,n);m.resolve(o)})};var h=function(n){m.reject(n)};this.connector.analyze(l,k,h)}else{b.warn("No text found in element.");m.resolve([])}},_extractText:function(h){if(h.get(0)&&h.get(0).tagName&&(h.get(0).tagName=="TEXTAREA"||h.get(0).tagName=="INPUT"&&h.attr("type","text"))){return h.get(0).val()}else{var g=h.text().replace(/\s+/g," ").replace(/\0\b\n\r\f\t/g,"");return e.trim(g)}}};d.prototype.OpenCalaisConnector=function(g){this.options=g;this.baseUrl=(c.isArray(g.url))?g.url:[g.url];this.enhancerUrlPrefix="/"};d.prototype.OpenCalaisConnector.prototype={analyze:function(m,l,i,h){if(!h){h={urlIndex:0}}if(h.urlIndex>=this.baseUrl.length){i("Could not connect to the given OpenCalais endpoints! Please check for their setup!");return}var g=this.baseUrl[h.urlIndex].replace(/\/$/,"");g+=this.enhancerUrlPrefix;var k=h.format||"application/rdf+json";var n=function(v,p,q,r,u){return function(){b.error("OpenCalais connection error",arguments);v.analyze(p,q,r,c.extend(u,{urlIndex:u.urlIndex+1}))}}(this,m,l,i,h);var j=this._prepareData(m);if(typeof exports!=="undefined"&&typeof process!=="undefined"){return this._analyzeNode(g,j,l,n,h,k)}e.ajax({success:function(p,o,r){var q=r.responseText.replace(/<!--[\s\S]*?-->/g,"");l(q)},error:n,type:"POST",url:g,data:j,accept:"text/plain"})},_analyzeNode:function(h,n,m,i,g,l){var k=require("request");var j=k({method:"POST",uri:h,body:n,headers:{Accept:l}},function(q,p,o){try{m({results:JSON.parse(o)})}catch(r){i(r)}});j.end()},_prepareData:function(g){return{licenseID:this.options.api_key,calculareRelevanceScore:"true",enableMetadataType:"GenericRelations,SocialTags",contentType:"text/html",content:g}}}})();(function(){d.prototype.RdfaRdfQueryService=function(g){var h={name:"rdfardfquery",namespaces:{},rules:[]};this.options=e.extend(true,h,g?g:{});this.views=[],this.vie=null;this.name=this.options.name};d.prototype.RdfaRdfQueryService.prototype={init:function(){for(var g in this.options.namespaces){var h=this.options.namespaces[g];this.vie.namespaces.add(g,h)}this.rules=e.extend([],d.Util.transformationRules(this));this.rules=e.merge(this.rules,(this.options.rules)?this.options.rules:[])},analyze:function(g){return this.load(g)},load:function(m){var g=this;var h=m instanceof this.vie.Loadable||m instanceof this.vie.Analyzable;if(!h){throw new Error("Invalid Loadable/Analyzable passed")}var j=m.options.element?m.options.element:e(document);try{var i=e(j).find("[about],[typeof]").rdfa();e.each(e(j).xmlns(),function(o,n){g.vie.namespaces.addOrReplace(o,n.toString())});var l=d.Util.rdf2Entities(this,i);m.resolve(l)}catch(k){m.reject(k)}},save:function(j){var h=j instanceof this.vie.Savable;if(!h){j.reject("Invalid Savable passed")}if(!j.options.element){j.reject("Unable to write entity to RDFa, no element given")}if(!j.options.entity){j.reject("Unable to write to RDFa, no entity given")}if(!e.rdf){j.reject("No rdfQuery found.")}var g=j.options.entity;var k=[];var i=g.get("@type");i=(e.isArray(i))?i[0]:i;i=i.id;k.push(g.getSubject()+" a "+i);e(j.options.element).rdfa(k);j.resolve()}}})();(function(){d.prototype.RdfaService=function(g){var h={name:"rdfa",namespaces:{},subjectSelector:"[about],[typeof],[src],html",predicateSelector:"[property],[rel]",rules:[]};this.options=e.extend(true,h,g?g:{});this.views=[],this.vie=null;this.name=this.options.name};d.prototype.RdfaService.prototype={init:function(){for(var g in this.options.namespaces){var h=this.options.namespaces[g];this.vie.namespaces.add(g,h)}this.rules=e.merge([],d.Util.transformationRules(this));this.rules=e.merge(this.rules,(this.options.rules)?this.options.rules:[])},analyze:function(g){return this.load(g)},load:function(n){var h=this;var i=n instanceof this.vie.Loadable||n instanceof this.vie.Analyzable;if(!i){throw new Error("Invalid Loadable/Analyzable passed")}var j;if(!n.options.element){if(typeof document==="undefined"){return n.resolve([])}j=e(document)}else{j=n.options.element}var k=this.xmlns(j);for(var l in k){this.vie.namespaces.addOrReplace(l,k[l])}var m=[];var g=e(this.options.subjectSelector,j).add(e(j).filter(this.options.subjectSelector)).each(function(){var o=h._readEntity(e(this));if(o){m.push(o)}});n.resolve(m)},save:function(h){var g=h instanceof this.vie.Savable;if(!g){throw"Invalid Savable passed"}if(!h.options.element){throw"Unable to write entity to RDFa, no element given"}if(!h.options.entity){throw"Unable to write to RDFa, no entity given"}this._writeEntity(h.options.entity,h.options.element);h.resolve()},_readEntity:function(j){var l=this.getElementSubject(j);var k=this._getElementType(j);var o,n,g;var i=this._readEntityPredicates(l,j,false);if(e.isEmptyObject(i)){return null}var m=this.vie;for(o in i){n=i[o];if(!c.isArray(n)){continue}g=new this.vie.Collection();g.vie=this.vie;c.each(n,function(p){var q=m.entities.addOrUpdate({"@subject":p});g.addOrUpdate(q)});i[o]=g}i["@subject"]=l;if(k){i["@type"]=k}var h=new this.vie.Entity(i);h=this.vie.entities.addOrUpdate(h,{updateOptions:{silent:true}});this._registerEntityView(h,j);return h},_writeEntity:function(h,i){var g=this;this.findPredicateElements(this.getElementSubject(i),i,true).each(function(){var k=e(this);var j=g.getElementPredicate(k);if(!h.has(j)){return true}var l=h.get(j);if(l&&l.isCollection){return true}if(l===g.readElementValue(j,k)){return true}g.writeElementValue(j,k,l)});return true},_getViewForElement:function(i,g){var h;e.each(this.views,function(){if(e(this.el).get(0)===i.get(0)){if(g&&!this.template){return true}h=this;return false}});return h},_registerEntityView:function(i,j){if(!j.length){return}var g=this;var h=this._getViewForElement(j);if(h){return h}h=new this.vie.view.Entity({model:i,el:j,tagName:j.get(0).nodeName,vie:this.vie,service:this.name});this.views.push(h);c.each(i.attributes,function(m,k){var l=i.fromReference(i.get(k));if(l&&l.isCollection){e.each(g.getElementByPredicate(k,j),function(){g._registerCollectionView(l,e(this),i)})}});return h},_registerCollectionView:function(k,i,h){var g=this._getViewForElement(i,true);if(g){return g}var j=i.children(":first-child");g=new this.vie.view.Collection({owner:h,collection:k,model:k.model,el:i,template:j,service:this,tagName:i.get(0).nodeName});this.views.push(g);return g},_getElementType:function(g){var h;if(e(g).attr("typeof")!==this.options.attributeExistenceComparator){h=e(g).attr("typeof");if(h.indexOf("://")!==-1){return"<"+h+">"}else{return h}}return null},getElementSubject:function(j){var h=this;if(typeof document!=="undefined"){if(j===document){return document.baseURI}}var i=undefined;var g=null;e(j).closest(this.options.subjectSelector).each(function(){g=this;if(e(this).attr("about")!==h.options.attributeExistenceComparator){i=e(this).attr("about");return true}if(e(this).attr("src")!==h.options.attributeExistenceComparator){i=e(this).attr("src");return true}if(e(this).attr("typeof")!==h.options.attributeExistenceComparator){return true}if(e(this).get(0).nodeName==="HTML"){e("base",this).each(function(){i=e(this).attr("href")})}});if(!i){if(g===j){return h.getElementSubject(e(j).parent())}return undefined}if(typeof i==="object"){return i}if(i.indexOf("_:")===0){return i}if(i.indexOf("<")===0){return i}return"<"+i+">"},setElementSubject:function(h,g){if(e(g).attr("src")){return e(g).attr("src",h)}return e(g).attr("about",h)},getElementPredicate:function(h){var g;h=e(h);g=h.attr("property");if(!g){g=h.attr("rel")}return g},getElementBySubject:function(i,h){var g=this;return e(h).find(this.options.subjectSelector).add(e(h).filter(this.options.subjectSelector)).filter(function(){if(g.getElementSubject(e(this))!==i){return false}return true})},getElementByPredicate:function(h,j){var g=this;var i=this.getElementSubject(j);return e(j).find(this.options.predicateSelector).add(e(j).filter(this.options.predicateSelector)).filter(function(){var k=g.getElementPredicate(e(this));if(g.vie.namespaces.curie(k)!==g.vie.namespaces.curie(h)){return false}if(g.getElementSubject(this)!==i){return false}return true})},_readEntityPredicates:function(i,h,k){var g=this;var j={};this.findPredicateElements(i,h,true).each(function(){var m=e(this);var l=g.getElementPredicate(m);if(l===""){return}var n=g.readElementValue(l,m);if(n===null&&!k){return}j[l]=n});if(e(h).get(0).tagName!=="HTML"){e(h).parent("[rev]").each(function(){var l=e(this).attr("rev");if(!l){return}j[e(this).attr("rev")]=g.getElementSubject(this)})}return j},findPredicateElements:function(j,i,h){var g=this;return e(i).find(this.options.predicateSelector).add(e(i).filter(this.options.predicateSelector)).filter(function(){if(g.getElementSubject(this)!==j){return false}if(!h){if(!e(this).parents("[property]").length){return true}return false}return true})},readElementValue:function(h,j){var k=j.attr("content");if(k){return k}var m=j.attr("resource");if(m){return["<"+m+">"]}var i=j.attr("href");if(i&&j.attr("rel")===h){return["<"+i+">"]}if(j.attr("rel")){var l=[];var g=this;e(j).children(this.options.subjectSelector).each(function(){l.push(g.getElementSubject(this))});return l}return j.html()},writeElementValue:function(g,h,k){if(c.isArray(k)&&k.length>0){k=k[0]}var i=h.attr("content");if(i){h.attr("content",k);return}var j=h.attr("resource");if(j){h.attr("resource",k)}h.html(k)},xmlns:function(h){var g;if(!h){if(typeof document==="undefined"){return{}}g=e(document)}else{g=e(h)}g=g.add(g.parents());var i={};g.each(function(k,n){if(n.attributes){for(k=0;k<n.attributes.length;k+=1){var j=n.attributes[k];if(/^xmlns(:(.+))?$/.test(j.nodeName)){var m=/^xmlns(:(.+))?$/.exec(j.nodeName)[2]||"";var l=j.nodeValue;if(m===""||l!==""){i[m]=j.nodeValue}}}}});return i}}})();(function(){d.prototype.StanbolService=function(g){var h={name:"stanbol",url:["http://dev.iks-project.eu/stanbolfull"],timeout:20000,namespaces:{semdeski:"http://www.semanticdesktop.org/ontologies/2007/01/19/nie#",semdeskf:"http://www.semanticdesktop.org/ontologies/2007/03/22/nfo#",skos:"http://www.w3.org/2004/02/skos/core#",foaf:"http://xmlns.com/foaf/0.1/",opengis:"http://www.opengis.net/gml/",dbpedia:"http://dbpedia.org/ontology/",dbprop:"http://dbpedia.org/property/",owl:"http://www.w3.org/2002/07/owl#",geonames:"http://www.geonames.org/ontology#",enhancer:"http://fise.iks-project.eu/ontology/",entityhub:"http://www.iks-project.eu/ontology/rick/model/",entityhub2:"http://www.iks-project.eu/ontology/rick/query/",rdf:"http://www.w3.org/1999/02/22-rdf-syntax-ns#",rdfs:"http://www.w3.org/2000/01/rdf-schema#",dcterms:"http://purl.org/dc/terms/",schema:"http://schema.org/",geo:"http://www.w3.org/2003/01/geo/wgs84_pos#"},rules:[{left:["?subject a <http://fise.iks-project.eu/ontology/EntityAnnotation>","?subject enhancer:entity-type ?type","?subject enhancer:confidence ?confidence","?subject enhancer:entity-reference ?entity","?subject dcterms:relation ?relation","?relation a <http://fise.iks-project.eu/ontology/TextAnnotation>","?relation enhancer:selected-text ?selected-text","?relation enhancer:selection-context ?selection-context","?relation enhancer:start ?start","?relation enhancer:end ?end"],right:["?entity a ?type","?entity enhancer:hasTextAnnotation ?relation","?entity enhancer:hasEntityAnnotation ?subject"]}],enhancer:{chain:"default"},entityhub:{site:undefined}};this.options=e.extend(true,h,g?g:{});this.vie=null;this.name=this.options.name};d.prototype.StanbolService.prototype={init:function(){for(var g in this.options.namespaces){var h=this.options.namespaces[g];this.vie.namespaces.add(g,h)}this.rules=e.extend([],d.Util.transformationRules(this));this.rules=e.merge(this.rules,(this.options.rules)?this.options.rules:[]);this.connector=new this.vie.StanbolConnector(this.options);this.vie.types.addOrOverwrite("enhancer:EntityAnnotation",[]).inherit("owl:Thing");this.vie.types.addOrOverwrite("enhancer:TextAnnotation",[]).inherit("owl:Thing");this.vie.types.addOrOverwrite("enhancer:Enhancement",[]).inherit("owl:Thing")},analyze:function(n){var g=this;var j=n instanceof this.vie.Analyzable;if(!j){throw"Invalid Analyzable passed"}var k=n.options.element?n.options.element:e("body");var m=g._extractText(k);if(m.length>0){var l=function(o){c.defer(function(){var p=d.Util.rdf2Entities(g,o);n.resolve(p)})};var i=function(o){n.reject(o)};var h={chain:(n.options.chain)?n.options.chain:g.options.enhancer.chain};this.connector.analyze(m,l,i,h)}else{b.warn("No text found in element.");n.resolve([])}},find:function(m){var k=m instanceof this.vie.Findable;if(!k){throw"Invalid Findable passed"}var j=this;if(!m.options.term){b.info("StanbolConnector: No term to look for!");m.reject([])}var g=escape(m.options.term);var h=(typeof m.options.limit==="undefined")?20:m.options.limit;var i=(typeof m.options.offset==="undefined")?0:m.options.offset;var q=function(r){c.defer(function(){var s=d.Util.rdf2Entities(j,r);m.resolve(s)})};var n=function(r){m.reject(r)};m.options.site=(m.options.site)?m.options.site:j.options.entityhub.site;var o=this.vie;if(m.options.properties){var l=m.options.properties;m.options.ldPath=c(l).map(function(r){if(o.namespaces.isCurie(r)){return o.namespaces.uri(r)+";"}else{return r}}).join("")}if(m.options.field&&o.namespaces.isCurie(p)){var p=m.options.field;m.options.field=o.namespaces.uri(p)}this.connector.find(g,h,i,q,n,m.options)},load:function(m){var k=m instanceof this.vie.Loadable;if(!k){throw"Invalid Loadable passed"}var g=this;var h=m.options.entity;if(!h){b.warn("StanbolConnector: No entity to look for!");m.resolve([])}var l=function(n){c.defer(function(){var o=d.Util.rdf2Entities(g,n);m.resolve(o)})};var j=function(n){m.reject(n)};var i={site:(m.options.site)?m.options.site:g.options.entityhub.site,local:m.options.local};this.connector.load(h,l,j,i)},save:function(l){var k=l instanceof this.vie.Savable;if(!k){throw"Invalid Savable passed"}var g=this;var h=l.options.entity;if(!h){b.warn("StanbolConnector: No entity to save!");l.reject("StanbolConnector: No entity to save!")}var m=function(n){c.defer(function(){var o=d.Util.rdf2Entities(g,n);l.resolve(o)})};var j=function(n){l.reject(n)};var i={site:(loadable.options.site)?loadable.options.site:g.options.entityhub.site,local:loadable.options.local};this.connector.save(h,m,j,i)},_extractText:function(h){if(h.get(0)&&h.get(0).tagName&&(h.get(0).tagName=="TEXTAREA"||h.get(0).tagName=="INPUT"&&h.attr("type","text"))){return h.get(0).val()}else{var g=h.text().replace(/\s+/g," ").replace(/\0\b\n\r\f\t/g,"");return e.trim(g)}}};d.prototype.StanbolConnector=function(g){var h={url:["http://dev.iks-project.eu/stanbolfull"],timeout:20000,enhancer:{urlPostfix:"/enhancer",chain:"default"},entityhub:{site:undefined,urlPostfix:"/entityhub",local:false},sparql:{urlPostfix:"/sparql"},contenthub:{urlPostfix:"/contenthub",index:"contenthub"},ontonet:{urlPostfix:"/ontonet"},factstore:{urlPostfix:"/factstore"},rules:{urlPostfix:"/rules"},cmsadapter:{urlPostfix:"/cmsadapter"}};this.options=e.extend(true,h,g?g:{});this.options.url=(c.isArray(this.options.url))?this.options.url:[this.options.url];this._init();this.baseUrl=(c.isArray(g.url))?g.url:[g.url]};d.prototype.StanbolConnector.prototype={_init:function(){var g=this;e.ajaxSetup({converters:{"text application/rdf+json":function(h){return JSON.parse(h)}},timeout:g.options.timeout});return this},_iterate:function(g){if(!g){return}if(g.urlIndex>=this.options.url.length){g.error.call(this,"Could not connect to the given Stanbol endpoints! Please check for their setup!");return}var h=function(j,i){return function(){b.log("Stanbol connection error",arguments);i.urlIndex=i.urlIndex+1;j._iterate(i)}}(this,g);if(typeof exports!=="undefined"&&typeof process!=="undefined"){return g.methodNode.call(this,g.url.call(this,g.urlIndex,g.args.options),g.args,g.success,h)}return g.method.call(this,g.url.call(this,g.urlIndex,g.args.options),g.args,g.success,h)},analyze:function(k,j,i,h){h=(h)?h:{};var g=this;g._iterate({method:g._analyze,methodNode:g._analyzeNode,url:function(l,o){var n=(o.chain)?o.chain:this.options.enhancer.chain;var m=this.options.url[l].replace(/\/$/,"");m+=this.options.enhancer.urlPostfix+"/chain/"+n.replace(/\/$/,"");return m},args:{text:k,format:h.format||"application/rdf+json",options:h},success:j,error:i,urlIndex:0})},_analyze:function(i,h,j,g){e.ajax({success:j,error:g,url:i,type:"POST",data:h.text,dataType:h.format,contentType:"text/plain",accepts:{"application/rdf+json":"application/rdf+json"}})},_analyzeNode:function(i,h,l,g){var k=require("request");var j=k({method:"POST",uri:i,body:h.text,headers:{Accept:h.format,"Content-Type":"text/plain"}},function(o,n,m){try{l({results:JSON.parse(m)})}catch(p){g(p)}});j.end()},load:function(j,k,i,h){var g=this;h=(h)?h:{};h.uri=j.replace(/^</,"").replace(/>$/,"");g._iterate({method:g._load,methodNode:g._loadNode,success:k,error:i,url:function(l,p){var n=(p.site)?p.site:this.options.entityhub.site;n=(n)?"/"+n:"s";var o=p.local;var m=this.options.url[l].replace(/\/$/,"")+this.options.entityhub.urlPostfix;if(o){m+="/entity?id="+escape(p.uri)}else{m+="/site"+n+"/entity?id="+escape(p.uri)}return m},args:{format:h.format||"application/rdf+json",options:h},urlIndex:0})},_load:function(i,h,j,g){e.ajax({success:j,error:g,url:i,type:"GET",dataType:h.format,contentType:"text/plain",accepts:{"application/rdf+json":"application/rdf+json"}})},_loadNode:function(i,h,l,g){var k=require("request");var j=k({method:"GET",uri:i,body:h.text,headers:{Accept:h.format}},function(o,n,m){try{l({results:JSON.parse(m)})}catch(p){g(p)}});j.end()},find:function(k,h,m,l,j,i){i=(i)?i:{};var g=this;if(!k||k===""){j("No term given!");return}m=(m)?m:0;h=(h)?h:10;g._iterate({method:g._find,methodNode:g._findNode,success:l,error:j,url:function(n,r){var p=(r.site)?r.site:this.options.entityhub.site;p=(p)?"/"+p:"s";var q=r.local;var o=this.options.url[n].replace(/\/$/,"")+this.options.entityhub.urlPostfix;if(q){o+="/sites/find"}else{o+="/site"+p+"/find"}return o},args:{term:k,offset:m,limit:h,format:i.format||"application/rdf+json",options:i},urlIndex:0})},_find:function(i,h,j,g){e.ajax({success:j,error:g,url:i,type:"POST",data:"name="+h.term+"&limit="+h.limit+"&offset="+h.offset,dataType:h.format,contentType:"application/x-www-form-urlencoded",accepts:{"application/rdf+json":"application/rdf+json"}})},_findNode:function(i,h,l,g){var k=require("request");var j=k({method:"POST",uri:i,body:"name="+h.term+"&limit="+h.limit+"&offset="+h.offset,headers:{Accept:h.format}},function(o,n,m){try{l({results:JSON.parse(m)})}catch(p){g(p)}});j.end()},lookup:function(j,k,i,h){h=(h)?h:{};var g=this;j=j.replace(/^</,"").replace(/>$/,"");h.uri=j;h.create=(h.create)?h.create:false;g._iterate({method:g._lookup,methodNode:g._lookupNode,success:k,error:i,url:function(l,n){var m=this.options.url[l].replace(/\/$/,"")+this.options.entityhub.urlPostfix;m+="/lookup?id="+escape(n.uri)+"&create="+n.create;return m},args:{format:h.format||"application/rdf+json",options:h},urlIndex:0})},_lookup:function(i,h,j,g){e.ajax({success:j,error:g,url:i,type:"GET",dataType:h.format,contentType:"text/plain",accepts:{"application/rdf+json":"application/rdf+json"}})},_lookupNode:function(i,h,l,g){var k=require("request");var j=k({method:"GET",uri:i,body:h.text,headers:{Accept:h.format}},function(o,n,m){try{l({results:JSON.parse(m)})}catch(p){g(p)}});j.end()},referenced:function(k,i,h){h=(h)?h:{};var g=this;var j=function(p){if(c.isArray(p)){var n=[];for(var o=0,m=p.length;o<m;o++){n.push(p[o].replace(/.+\/(.+?)\/?$/,"$1"))}return k(n)}else{return k(p)}};g._iterate({method:g._referenced,methodNode:g._referencedNode,success:j,error:i,url:function(l,n){var m=this.options.url[l].replace(/\/$/,"");m+=this.options.entityhub.urlPostfix+"/sites/referenced";return m},args:{options:h},urlIndex:0})},_referenced:function(i,h,j,g){e.ajax({success:j,error:g,url:i,type:"GET",accepts:{"application/rdf+json":"application/rdf+json"}})},_referencedNode:function(i,h,l,g){var k=require("request");var j=k({method:"GET",uri:i,headers:{Accept:h.format}},function(o,n,m){try{l({results:JSON.parse(m)})}catch(p){g(p)}});j.end()},sparql:function(j,k,i,h){h=(h)?h:{};var g=this;g._iterate({method:g._sparql,methodNode:g._sparqlNode,success:k,error:i,url:function(l,n){var m=this.options.url[l].replace(/\/$/,"");m+=this.options.sparql.urlPostfix.replace(/\/$/,"");return m},args:{query:j,options:h},urlIndex:0})},_sparql:function(i,h,j,g){e.ajax({success:j,error:g,url:i,type:"POST",data:"query="+h.query,contentType:"application/x-www-form-urlencoded"})},_sparqlNode:function(i,h,l,g){var k=require("request");var j=k({method:"POST",uri:i,body:JSON.stringify({query:h.query}),headers:{Accept:h.format}},function(o,n,m){try{l({results:JSON.parse(m)})}catch(p){g(p)}});j.end()},ldpath:function(k,j,m,i,h){h=(h)?h:{};var g=this;j=(c.isArray(j))?j:[j];var l="";for(var n=0;n<j.length;n++){l+="&context="+j[n]}g._iterate({method:g._ldpath,methodNode:g._ldpathNode,success:m,error:i,url:function(o,s){var q=(s.site)?s.site:this.options.entityhub.site;q=(q)?"/"+q:"s";var r=s.local;var p=this.options.url[o].replace(/\/$/,"")+this.options.entityhub.urlPostfix;if(!r){p+="/site"+q}p+="/ldpath";return p},args:{ldpath:k,context:l,format:h.format||"application/rdf+json",options:h},urlIndex:0})},_ldpath:function(i,h,j,g){e.ajax({success:j,error:g,url:i,type:"POST",data:"ldpath="+h.ldpath+h.context,contentType:"application/x-www-form-urlencoded",dataType:h.format,accepts:{"application/rdf+json":"application/rdf+json"}})},_ldpathNode:function(i,h,l,g){var k=require("request");var j=k({method:"POST",uri:i,body:"ldpath="+h.ldpath+context,headers:{Accept:h.format}},function(o,n,m){try{l({results:JSON.parse(m)})}catch(p){g(p)}});j.end()},uploadContent:function(j,k,i,h){h=(h)?h:{};var g=this;g._iterate({method:g._uploadContent,methodNode:g._uploadContentNode,success:k,error:i,url:function(l,o){var n=this.options.url[l].replace(/\/$/,"");n+=this.options.contenthub.urlPostfix.replace(/\/$/,"");var m=(o.index)?o.index:this.options.contenthub.index;n+="/"+m.replace(/\/$/,"");n+="/store";return n},args:{content:j,options:h},urlIndex:0})},_uploadContent:function(i,h,j,g){e.ajax({success:j,error:g,url:i,type:"POST",data:h.content,contentType:"text/plain"})},_uploadContentNode:function(i,h,l,g){var k=require("request");var j=k({method:"POST",uri:i,body:h.content,headers:{Accept:"application/rdf+xml","Content-Type":"text/plain"}},function(o,n,m){try{l({results:JSON.parse(m)})}catch(p){g(p)}});j.end()},createFactSchema:function(j,k,l,i,h){h=(h)?h:{};var g=this;h.url=j;g._iterate({method:g._createFactSchema,methodNode:g._createFactSchemaNode,success:l,error:i,url:function(m,o){var n=this.options.url[m].replace(/\/$/,"");n+=this.options.factstore.urlPostfix.replace(/\/$/,"");n+="/facts/"+escape(o.url);return n},args:{url:j,schema:k,options:h},urlIndex:0})},_createFactSchema:function(i,h,j,g){e.ajax({success:j,error:g,url:i,type:"PUT",data:h.schema,contentType:"application/json",dataType:"application/json"})},_createFactSchemaNode:function(i,h,l,g){var k=require("request");var j=k({method:"PUT",uri:i,body:h.schema,headers:{Accept:"application/json","Content-Type":"application/json"}},function(o,n,m){try{l({results:JSON.parse(m)})}catch(p){g(p)}});j.end()},createFact:function(j,k,i,h){h=(h)?h:{};var g=this;g._iterate({method:g._createFact,methodNode:g._createFactNode,success:k,error:i,url:function(l,n){var m=this.options.url[l].replace(/\/$/,"");m+=this.options.factstore.urlPostfix.replace(/\/$/,"");m+="/facts";return m},args:{fact:j,options:h},urlIndex:0})},_createFact:function(i,h,j,g){e.ajax({success:j,error:g,url:i,type:"POST",data:h.fact,contentType:"application/json",dataType:"application/json"})},_createFactNode:function(i,h,l,g){var k=require("request");var j=k({method:"POST",uri:i,body:h.fact,headers:{Accept:"application/json","Content-Type":"application/json"}},function(o,n,m){try{l({results:JSON.parse(m)})}catch(p){g(p)}});j.end()},queryFact:function(j,k,i,h){h=(h)?h:{};var g=this;g._iterate({method:g._queryFact,methodNode:g._queryFactNode,success:k,error:i,url:function(l,n){var m=this.options.url[l].replace(/\/$/,"");m+=this.options.factstore.urlPostfix.replace(/\/$/,"");m+="/query";return m},args:{query:j,options:h},urlIndex:0})},_queryFact:function(i,h,j,g){e.ajax({success:j,error:g,url:i,type:"POST",data:h.query,contentType:"application/json",dataType:"application/json"})},_queryFactNode:function(i,h,l,g){var k=require("request");var j=k({method:"POST",uri:i,body:h.query,headers:{Accept:"application/json","Content-Type":"application/json"}},function(o,n,m){try{l({results:JSON.parse(m)})}catch(p){g(p)}});j.end()}}})();(function(){d.prototype.ZemantaService=function(g){var h={name:"zemanta",url:["http://api.zemanta.com/services/rest/0.0/"],timeout:20000,namespaces:{zemanta:"http://s.zemanta.com/ns#"},rules:[{left:["?subject a zemanta:Recognition","?subject zemanta:object ?object","?object owl:sameAs ?entity"],right:["?entity zemanta:hasEntityAnnotation ?subject"]}],api_key:undefined};this.options=e.extend(true,h,g?g:{});this.vie=null;this.name=this.options.name;e.ajaxSetup({converters:{"text application/rdf+json":function(i){return JSON.parse(i)}},timeout:this.options.timeout})};d.prototype.ZemantaService.prototype={init:function(){for(var g in this.options.namespaces){var h=this.options.namespaces[g];this.vie.namespaces.add(g,h)}this.rules=e.extend([],d.Util.transformationRules(this));this.rules=e.merge(this.rules,(this.options.rules)?this.options.rules:[]);this.connector=new this.vie.ZemantaConnector(this.options);this.vie.types.addOrOverwrite("zemanta:Recognition",[]).inherit("owl:Thing")},analyze:function(n){var g=this;var j=n instanceof this.vie.Analyzable;if(!j){throw"Invalid Analyzable passed"}var k=n.options.element?n.options.element:e("body");var m=g._extractText(k);if(m.length>0){var l=function(o){c.defer(function(){var p=d.Util.rdf2Entities(g,o);n.resolve(p)})};var i=function(o){n.reject(o)};var h={};this.connector.analyze(m,l,i,h)}else{b.warn("No text found in element.");n.resolve([])}},_extractText:function(g){return e(g).wrap("<div>").parent().html()}};d.prototype.ZemantaConnector=function(g){var h={url:["http://api.zemanta.com/services/rest/0.0/"],timeout:20000,api_key:undefined};this.options=e.extend(true,h,g?g:{});this.options.url=(c.isArray(this.options.url))?this.options.url:[this.options.url];this._init();this.baseUrl=(c.isArray(g.url))?g.url:[g.url]};d.prototype.ZemantaConnector.prototype={_init:function(){var g=this;e.ajaxSetup({converters:{"text application/rdf+json":function(h){return JSON.parse(h)}},timeout:g.options.timeout});return this},_iterate:function(g){if(!g){return}if(g.urlIndex>=this.options.url.length){g.error.call(this,"Could not connect to the given Zemanta endpoints! Please check for their setup!");return}var h=function(j,i){return function(){b.log("Zemanta connection error",arguments);i.urlIndex=i.urlIndex+1;j._iterate(i)}}(this,g);if(typeof exports!=="undefined"&&typeof process!=="undefined"){return g.methodNode.call(this,g.url.call(this,g.urlIndex,g.args.options),g.args,g.success,h)}return g.method.call(this,g.url.call(this,g.urlIndex,g.args.options),g.args,g.success,h)},analyze:function(k,j,i,h){h=(h)?h:{};var g=this;g._iterate({method:g._analyze,methodNode:g._analyzeNode,success:j,error:i,url:function(l,n){var m=this.options.url[l].replace(/\/$/,"");return m},args:{text:k,format:h.format||"rdfxml",options:h},urlIndex:0})},_analyze:function(i,h,j,g){e.ajax({success:function(l,k,n){var m=n.responseText.replace(/<z:signature>.*?<\/z:signature>/,"");j(m)},error:g,url:i,type:"POST",dataType:"xml",data:{method:"zemanta.suggest",text:h.text,format:h.format,api_key:this.options.api_key,return_rdf_links:h.options.return_rdf_links},contentType:"text/plain",accepts:{"application/rdf+json":"application/rdf+json"}})},_analyzeNode:function(i,h,l,g){var k=require("request");var j=k({method:"POST",uri:i,body:h.text,headers:{Accept:h.format,"Content-Type":"text/plain"}},function(o,n,m){try{l({results:JSON.parse(m)})}catch(p){g(p)}});j.end()}}})();if(!d.prototype.view){d.prototype.view={}}d.prototype.view.Collection=f.View.extend({initialize:function(){this.template=this.options.template;this.service=this.options.service;if(!this.service){throw"No RDFa service provided to the Collection View"}this.owner=this.options.owner;this.entityViews={};c.bindAll(this,"addItem","removeItem","refreshItems");this.collection.bind("add",this.addItem);this.collection.bind("remove",this.removeItem);this.collection.bind("reset",this.refreshItems);var g=this;this.collection.forEach(function(h){g.registerItem(h,g.collection)})},addItem:function(i,n){if(n!==this.collection){return}if(!this.template||this.template.length===0){return}var h=this.service._registerEntityView(i,this.cloneElement(this.template,i));var j=e(h.render().el);if(i.id){this.service.setElementSubject(i.getSubjectUri(),j)}var l=n.indexOf(i);if(l===0){e(this.el).prepend(j)}else{var m=n.at(l-1);var k=this.entityViews[m.cid];if(k){e(k.el).after(j)}else{e(this.el).append(j)}}var g=this.service;j.parent("[rev]").each(function(){var o=e(this).attr("rev");var p={};p[o]=new g.vie.Collection();p[o].vie=g.vie;var q=g.vie.entities.get(g.getElementSubject(this));if(q){p[o].addOrUpdate(q)}i.set(p)});this.trigger("add",h);this.entityViews[i.cid]=h;j.show()},registerItem:function(h,j){var i=this.service.getElementBySubject(h.id,this.el);if(!i){return}var g=this.service._registerEntityView(h,i);this.entityViews[h.cid]=g},removeItem:function(g){if(!this.entityViews[g.cid]){return}this.trigger("remove",this.entityViews[g.cid]);e(this.entityViews[g.cid].el).remove();delete (this.entityViews[g.cid])},refreshItems:function(h){var g=this;c.each(this.entityViews,function(i,j){e(i.el).remove()});this.entityViews={};h.forEach(function(i){g.addItem(i,h)})},cloneElement:function(j,h){var k=e(j).clone(false);var g=this.service;if(k.attr("about")!==undefined){k.attr("about","")}k.find("[about]").attr("about","");var i=this.service.getElementSubject(k);g.findPredicateElements(i,k,false).each(function(){var l=g.getElementPredicate(e(this));if(h.get(l)&&h.get(l).isCollection){return true}g.writeElementValue(null,e(this),"")});return k}});if(!d.prototype.view){d.prototype.view={}}d.prototype.view.Entity=f.View.extend({initialize:function(g){this.service=g.service?g.service:"rdfa";this.vie=g.vie;c.bindAll(this,"render");this.model.bind("change",this.render)},render:function(){this.vie.save({element:this.el,entity:this.model}).to(this.service).execute();return this}});var a=this;(function(g){if(a.XDomainRequest){g.ajaxTransport(function(i){if(i.crossDomain&&i.async){if(i.timeout){i.xdrTimeout=i.timeout;delete i.timeout}var h;return{send:function(k,j){function m(n,q,p,o){h.onload=h.onerror=h.ontimeout=g.noop;h=undefined;j(n,q,p,o)}h=new XDomainRequest();if(i.dataType){var l="header_Accept="+encodeURIComponent(i.dataType);i.url=i.url+(i.url.indexOf("?")===-1?"?":"&")+l}h.open(i.type,i.url);h.onload=function(o,n){m(200,"OK",{text:h.responseText},"Content-Type: "+h.contentType)};h.onerror=function(n){b.error(JSON.stringify(n));m(404,"Not Found")};if(i.xdrTimeout){h.ontimeout=function(){m(0,"timeout")};h.timeout=i.xdrTimeout}h.send((i.hasContent&&i.data)||null)},abort:function(){if(h){h.onerror=g.noop();h.abort()}}}}})}})(e)})();